#!/usr/bin/env python3
"""Mock scontrol command for testing."""

import argparse
import sys

MOCK_JOB_INFO = {
    "12345": """JobId=12345 JobName=train_model
   UserId=testuser(1000) GroupId=researchers(1000)
   MCS_label=N/A
   Priority=4294901730 Nice=0 Account=ml_research QOS=normal
   JobState=RUNNING Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=02:34:56 TimeLimit=7-00:00:00 TimeMin=N/A
   SubmitTime=2024-01-15T08:00:00 EligibleTime=2024-01-15T08:00:00
   AccrueTime=2024-01-15T08:00:00
   StartTime=2024-01-15T08:01:00 EndTime=2024-01-22T08:01:00 Deadline=N/A
   SuspendTime=None SecsPreSuspend=0 LastSchedEval=2024-01-15T08:00:30
   Partition=gpu NumNodes=4 NumCPUs=32 NumTasks=4 CPUs/Task=8 ReqB:S:C:T=0:0:*:*
   TRES=cpu=32,mem=256G,node=4,gres/gpu=16
   Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=*
   MinCPUsNode=8 MinMemoryNode=64G MinTmpDiskNode=0
   Features=a100 DelayBoot=00:00:00
   OverSubscribe=OK Contiguous=0 Licenses=(null) Network=(null)
   Command=/home/testuser/projects/ml/train.sh
   WorkDir=/home/testuser/projects/ml
   StdErr=/home/testuser/projects/ml/logs/train_%j.err
   StdOut=/home/testuser/projects/ml/logs/train_%j.out
   Power=
   TresPerNode=gres:gpu:4
   NtasksPerTRES:0
   NodeList=gpu-node-[01-04]
   BatchHost=gpu-node-01
   ReqNodeList=(null) ExcNodeList=(null)""",
    "12344": """JobId=12344 JobName=train_model
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=0 Nice=0 Account=ml_research QOS=normal
   JobState=COMPLETED Reason=None Dependency=(null)
   Requeue=1 Restarts=2 BatchFlag=1 ExitCode=0:0
   RunTime=04:00:00 TimeLimit=7-00:00:00
   SubmitTime=2024-01-14T10:00:00 StartTime=2024-01-14T10:01:00 EndTime=2024-01-14T14:01:00
   Partition=gpu NumNodes=4 NumCPUs=32 NumTasks=4
   TRES=cpu=32,mem=256G,node=4,gres/gpu=16
   WorkDir=/home/testuser/projects/ml
   NodeList=gpu-node-[01-04]""",
    "12342": """JobId=12342 JobName=failed_job
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=0 Nice=0 Account=ml_research QOS=normal
   JobState=FAILED Reason=NonZeroExitCode Dependency=(null)
   Requeue=1 Restarts=3 BatchFlag=1 ExitCode=1:0
   DerivedExitCode=1:0
   RunTime=00:05:23 TimeLimit=1-00:00:00
   SubmitTime=2024-01-14T09:00:00 StartTime=2024-01-14T09:01:00 EndTime=2024-01-14T09:06:23
   Partition=gpu NumNodes=1 NumCPUs=8 NumTasks=1
   TRES=cpu=8,mem=64G,node=1,gres/gpu=1
   WorkDir=/home/testuser/projects/debug
   StdErr=/home/testuser/projects/debug/job.err
   StdOut=/home/testuser/projects/debug/job.out
   NodeList=gpu-node-02""",
}

# Default response for unknown jobs
DEFAULT_JOB = """JobId={job_id} JobName=unknown_job
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=1000 Nice=0 Account=default QOS=normal
   JobState=PENDING Reason=Priority Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 ExitCode=0:0
   RunTime=00:00:00 TimeLimit=1:00:00
   SubmitTime=2024-01-15T12:00:00
   Partition=cpu NumNodes=1 NumCPUs=1 NumTasks=1
   WorkDir=/home/testuser
   NodeList=(null)"""


def main() -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument("command", nargs="?", default="show")
    parser.add_argument("subcommand", nargs="?", default=None)
    parser.add_argument("job_id", nargs="?", default=None)
    args = parser.parse_args()

    if args.command == "show" and args.subcommand == "jobid":
        job_id = args.job_id
        if job_id in MOCK_JOB_INFO:
            print(MOCK_JOB_INFO[job_id])
        elif job_id and job_id.isdigit():
            print(DEFAULT_JOB.format(job_id=job_id))
        else:
            print("slurm_load_jobs error: Invalid job id specified", file=sys.stderr)
            sys.exit(1)
    else:
        print("Usage: scontrol show jobid <jobid>", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
