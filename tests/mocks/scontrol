#!/usr/bin/env python3
"""Mock scontrol command for testing."""

import argparse
import sys

MOCK_JOB_INFO = {
    "12345": """JobId=12345 JobName=train_model
   UserId=testuser(1000) GroupId=researchers(1000)
   MCS_label=N/A
   Priority=4294901730 Nice=0 Account=ml_research QOS=normal
   JobState=RUNNING Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=02:34:56 TimeLimit=7-00:00:00 TimeMin=N/A
   SubmitTime=2024-01-15T08:00:00 EligibleTime=2024-01-15T08:00:00
   AccrueTime=2024-01-15T08:00:00
   StartTime=2024-01-15T08:01:00 EndTime=2024-01-22T08:01:00 Deadline=N/A
   SuspendTime=None SecsPreSuspend=0 LastSchedEval=2024-01-15T08:00:30
   Partition=gpu NumNodes=4 NumCPUs=32 NumTasks=4 CPUs/Task=8 ReqB:S:C:T=0:0:*:*
   TRES=cpu=32,mem=256G,node=4,gres/gpu=16
   Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=*
   MinCPUsNode=8 MinMemoryNode=64G MinTmpDiskNode=0
   Features=a100 DelayBoot=00:00:00
   OverSubscribe=OK Contiguous=0 Licenses=(null) Network=(null)
   Command=/home/testuser/projects/ml/train.sh
   WorkDir=/home/testuser/projects/ml
   StdErr=/home/testuser/projects/ml/logs/train_%j.err
   StdOut=/home/testuser/projects/ml/logs/train_%j.out
   Power=
   TresPerNode=gres:gpu:4
   NtasksPerTRES:0
   NodeList=gpu-node-[01-04]
   BatchHost=gpu-node-01
   ReqNodeList=(null) ExcNodeList=(null)""",
    "12344": """JobId=12344 JobName=train_model
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=0 Nice=0 Account=ml_research QOS=normal
   JobState=COMPLETED Reason=None Dependency=(null)
   Requeue=1 Restarts=2 BatchFlag=1 ExitCode=0:0
   RunTime=04:00:00 TimeLimit=7-00:00:00
   SubmitTime=2024-01-14T10:00:00 StartTime=2024-01-14T10:01:00 EndTime=2024-01-14T14:01:00
   Partition=gpu NumNodes=4 NumCPUs=32 NumTasks=4
   TRES=cpu=32,mem=256G,node=4,gres/gpu=16
   WorkDir=/home/testuser/projects/ml
   NodeList=gpu-node-[01-04]""",
    "12342": """JobId=12342 JobName=failed_job
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=0 Nice=0 Account=ml_research QOS=normal
   JobState=FAILED Reason=NonZeroExitCode Dependency=(null)
   Requeue=1 Restarts=3 BatchFlag=1 ExitCode=1:0
   DerivedExitCode=1:0
   RunTime=00:05:23 TimeLimit=1-00:00:00
   SubmitTime=2024-01-14T09:00:00 StartTime=2024-01-14T09:01:00 EndTime=2024-01-14T09:06:23
   Partition=gpu NumNodes=1 NumCPUs=8 NumTasks=1
   TRES=cpu=8,mem=64G,node=1,gres/gpu=1
   WorkDir=/home/testuser/projects/debug
   StdErr=/home/testuser/projects/debug/job.err
   StdOut=/home/testuser/projects/debug/job.out
   NodeList=gpu-node-02""",
}

# Default response for unknown jobs
DEFAULT_JOB = """JobId={job_id} JobName=unknown_job
   UserId=testuser(1000) GroupId=researchers(1000)
   Priority=1000 Nice=0 Account=default QOS=normal
   JobState=PENDING Reason=Priority Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 ExitCode=0:0
   RunTime=00:00:00 TimeLimit=1:00:00
   SubmitTime=2024-01-15T12:00:00
   Partition=cpu NumNodes=1 NumCPUs=1 NumTasks=1
   WorkDir=/home/testuser
   NodeList=(null)"""


# Real node data from current cluster
MOCK_NODES_OUTPUT = """NodeName=daisg101 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=144 CPUEfctv=192 CPUTot=192 CPULoad=23.90
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg101 NodeHostName=daisg101 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=650000 FreeMem=1982929 Sockets=2 Boards=1
   State=MIXED+PLANNED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-09-26T13:21:42 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-29T06:47:17 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=144,mem=650000M,gres/gpu=6,gres/gpu:h200=6
   CurrentWatts=0 AveWatts=0

NodeName=daisg102 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=192 CPUEfctv=192 CPUTot=192 CPULoad=16.45
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg102 NodeHostName=daisg102 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=1050000 FreeMem=1903607 Sockets=2 Boards=1
   State=ALLOCATED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-09-26T13:19:04 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-23T12:06:19 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=192,mem=1050000M,gres/gpu=8,gres/gpu:h200=8
   CurrentWatts=0 AveWatts=0

NodeName=daisg103 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=192 CPUEfctv=192 CPUTot=192 CPULoad=6.39
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg103 NodeHostName=daisg103 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=500000 FreeMem=1989378 Sockets=2 Boards=1
   State=ALLOCATED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-09-26T13:22:13 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-30T22:07:46 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=192,mem=500000M,gres/gpu=8,gres/gpu:h200=8
   CurrentWatts=0 AveWatts=0

NodeName=daisg104 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=192 CPUEfctv=192 CPUTot=192 CPULoad=16.62
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg104 NodeHostName=daisg104 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=2000000 FreeMem=1916923 Sockets=2 Boards=1
   State=ALLOCATED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-09-26T13:22:34 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-30T22:44:15 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=192,mem=2000000M,gres/gpu=8,gres/gpu:h200=8
   CurrentWatts=0 AveWatts=0

NodeName=daisg105 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=144 CPUEfctv=192 CPUTot=192 CPULoad=15.01
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg105 NodeHostName=daisg105 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=482768 FreeMem=1882824 Sockets=2 Boards=1
   State=MIXED+PLANNED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-11-04T08:05:50 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-30T03:25:52 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=144,mem=482768M,gres/gpu=6,gres/gpu:h200=6
   CurrentWatts=0 AveWatts=0

NodeName=daisg106 Arch=x86_64 CoresPerSocket=48
   CPUAlloc=192 CPUEfctv=192 CPUTot=192 CPULoad=3.14
   AvailableFeatures=emeraldrapids,mem2T,gpu
   ActiveFeatures=emeraldrapids,mem2T,gpu
   Gres=gpu:h200:8(S:0-1)
   NodeAddr=daisg106 NodeHostName=daisg106 Version=24.11.6
   OS=Linux 6.4.0-150600.23.70-default #1 SMP PREEMPT_DYNAMIC Wed Sep 10 10:54:24 UTC 2025 (225af75)
   RealMemory=2000000 AllocMem=2000000 FreeMem=1222744 Sockets=2 Boards=1
   State=ALLOCATED ThreadsPerCore=2 TmpDisk=0 Weight=1 Owner=N/A MCS_label=N/A
   Partitions=gpu,gpu1,rvs
   BootTime=2025-09-26T13:22:04 SlurmdStartTime=2025-11-26T10:29:37
   LastBusyTime=2025-12-30T17:47:46 ResumeAfterTime=None
   CfgTRES=cpu=192,mem=2000000M,billing=192,gres/gpu=8,gres/gpu:h200=8
   AllocTRES=cpu=192,mem=2000000M,gres/gpu=8,gres/gpu:h200=8
   CurrentWatts=0 AveWatts=0
"""


def main() -> None:
    """Main entry point for mock scontrol command."""
    parser = argparse.ArgumentParser()
    parser.add_argument("command", nargs="?", default="show")
    parser.add_argument("subcommand", nargs="?", default=None)
    parser.add_argument("job_id", nargs="?", default=None)
    args = parser.parse_args()

    if args.command == "show" and args.subcommand == "jobid":
        job_id = args.job_id
        if job_id in MOCK_JOB_INFO:
            print(MOCK_JOB_INFO[job_id])
        elif job_id and job_id.isdigit():
            print(DEFAULT_JOB.format(job_id=job_id))
        else:
            print("slurm_load_jobs error: Invalid job id specified", file=sys.stderr)
            sys.exit(1)
    elif args.command == "show" and args.subcommand == "nodes":
        # Return real node data from current cluster
        print(MOCK_NODES_OUTPUT, end="")
    else:
        print("Usage: scontrol show <jobid|nodes> [<id>]", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
