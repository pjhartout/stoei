#!/usr/bin/env python3
"""Mock squeue command for testing."""

import argparse
import random

# Constants for parsing
MIN_JOB_FIELDS_WITH_USER = 7
MIN_JOB_FIELDS_WITH_TRES = 8
MIN_JOB_FIELDS_WITHOUT_USER = 6
MIN_USER_INDEX = 2
MIN_RANDOM_JOBS = 2
MAX_RANDOM_JOBS = 10

# Real job data from current cluster (with user field and TRES)
MOCK_JOBS_ALL_USERS = [
    ("47441", "rope_pct_llama_", "afkhan", "PENDING", "0:00", "8", "(Priority)", "cpu=64,mem=512G,node=8,gres/gpu=32"),
    ("47434", "rope_pct_llama_", "afkhan", "PENDING", "0:00", "8", "(Resources)", "cpu=64,mem=512G,node=8,gres/gpu=32"),
    ("47587", "sam3_multigpu", "flkar", "RUNNING", "5:29:36", "1", "daisg106", "cpu=192,mem=2000G,node=1,gres/gpu=8"),
    (
        "47474_5",
        "sdvae_sit_b_2_r",
        "xichen",
        "RUNNING",
        "18:29",
        "1",
        "daisg114",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47475_2",
        "sdvae_sit_b_2_r",
        "xichen",
        "RUNNING",
        "32:59",
        "1",
        "daisg104",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    ("47429", "train", "rmaser", "RUNNING", "12:30:07", "1", "daisg116", "cpu=192,mem=2000G,node=1,gres/gpu=8"),
    (
        "46043",
        "foldmae",
        "dchen",
        "RUNNING",
        "12:58:54",
        "4",
        "daisg[111-113,115]",
        "cpu=768,mem=8000G,node=4,gres/gpu=32",
    ),
    ("47537", "foldmae", "dchen", "PENDING", "0:00", "4", "(Priority)", "cpu=768,mem=8000G,node=4,gres/gpu=32"),
    (
        "47670",
        "17_imagenet128_",
        "bpogodzi",
        "PENDING",
        "0:00",
        "1",
        "(Nodes requi",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47671",
        "17_imagenet128_",
        "bpogodzi",
        "PENDING",
        "0:00",
        "1",
        "(Priority)",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47462_11",
        "decomposed_rep_",
        "jvanders",
        "RUNNING",
        "4:28",
        "1",
        "daisg103",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47458_11",
        "decomposed_rep_",
        "jvanders",
        "RUNNING",
        "8:59",
        "1",
        "daisg102",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47461_11",
        "lora_rep_rope_f",
        "jvanders",
        "RUNNING",
        "8:59",
        "1",
        "daisg103",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47457_11",
        "lora_rep_rope_r",
        "jvanders",
        "RUNNING",
        "12:29",
        "1",
        "daisg101",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    ("47466_2", "train", "rmaser", "RUNNING", "10:10:41", "1", "daisg108", "cpu=192,mem=2000G,node=1,gres/gpu=8"),
    ("47466_3", "train", "rmaser", "RUNNING", "10:10:41", "1", "daisg109", "cpu=192,mem=2000G,node=1,gres/gpu=8"),
    ("47466_4", "train", "rmaser", "RUNNING", "10:10:41", "1", "daisg110", "cpu=192,mem=2000G,node=1,gres/gpu=8"),
    (
        "47649_8",
        "pat_commonsense",
        "adhikar",
        "RUNNING",
        "2:18:57",
        "1",
        "daisg105",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47649_6",
        "pat_commonsense",
        "adhikar",
        "RUNNING",
        "2:28:06",
        "1",
        "daisg107",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
    (
        "47649_0",
        "pat_commonsense",
        "adhikar",
        "RUNNING",
        "2:28:32",
        "1",
        "daisg110",
        "cpu=192,mem=2000G,node=1,gres/gpu=8",
    ),
]

# Jobs without user field (for -u flag)
MOCK_JOBS_USER_ONLY = [
    ("12345", "train_model", "RUNNING", "2:34:56", "4", "gpu-node-[01-04]"),
    ("12346", "preprocess", "RUNNING", "0:45:12", "1", "cpu-node-05"),
    ("12347", "evaluate", "PENDING", "0:00", "2", "(Priority)"),
    ("12348", "inference", "PENDING", "0:00", "1", "(Resources)"),
    ("12349", "data_load", "RUNNING", "1:23:45", "1", "gpu-node-08"),
]


def main() -> None:
    """Main entry point for mock squeue command."""
    parser = argparse.ArgumentParser()
    parser.add_argument("-u", "--user", default=None)
    parser.add_argument("-o", "--format", default=None)
    parser.add_argument("-a", "--all", action="store_true")
    args = parser.parse_args()

    # Determine format - check if user field is in format string
    has_user_field = args.format and "%.8u" in args.format
    is_all_users = args.all or (not args.user and has_user_field)

    # Check if TRES field is in format (indicated by %t)
    has_tres_field = args.format and "%t" in args.format

    if is_all_users and has_user_field:
        # All users format with user field
        if has_tres_field:
            print("     JOBID|           NAME|    USER|   STATE|      TIME|NODE|NODELIST(REASON)|TRES")
        else:
            print("     JOBID|           NAME|    USER|   STATE|      TIME|NODE|NODELIST(REASON)")
        jobs = MOCK_JOBS_ALL_USERS
    else:
        # User-specific format without user field
        print("     JOBID|        JOBNAME|   STATE|      TIME|   NODES|      NODELIST")
        jobs = MOCK_JOBS_USER_ONLY

    # Filter by user if specified
    if args.user and has_user_field:
        jobs = [job for job in jobs if len(job) > MIN_USER_INDEX and job[MIN_USER_INDEX] == args.user]
    elif args.user and not has_user_field:
        # For user-specific format, just return some jobs
        jobs = MOCK_JOBS_USER_ONLY

    # Randomly select some jobs to simulate dynamic queue
    num_jobs = random.randint(MIN_RANDOM_JOBS, min(len(jobs), MAX_RANDOM_JOBS))  # noqa: S311
    selected_jobs = random.sample(jobs, num_jobs)

    for job in selected_jobs:
        if has_user_field and len(job) >= MIN_JOB_FIELDS_WITH_USER:
            job_id, name, user, state, time, nodes, nodelist = job[:MIN_JOB_FIELDS_WITH_USER]
            if has_tres_field and len(job) >= MIN_JOB_FIELDS_WITH_TRES:
                tres = job[7]
                print(f"{job_id:>10}|{name:>15}|{user:>8}|{state:>8}|{time:>10}|{nodes:>4}|{nodelist:>12}|{tres}")
            else:
                print(f"{job_id:>10}|{name:>15}|{user:>8}|{state:>8}|{time:>10}|{nodes:>4}|{nodelist:>12}")
        elif len(job) >= MIN_JOB_FIELDS_WITHOUT_USER:
            job_id, name, state, time, nodes, nodelist = job[:MIN_JOB_FIELDS_WITHOUT_USER]
            print(f"{job_id:>10}|{name:>15}|{state:>8}|{time:>10}|{nodes:>7}|{nodelist:>14}")


if __name__ == "__main__":
    main()
